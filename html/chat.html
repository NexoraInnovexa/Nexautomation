<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smart Chat Dashboard</title>
<style>
body {
  margin: 0;
  font-family: "Inter", sans-serif;
  display: flex;
  height: 100vh;
  background: #f9fafb;
  color: #333;
}

/* ===== Sidebar ===== */
.sidebar {
  width: 280px;
  background: #fff;
  border-right: 1px solid #e5e7eb;
  display: flex;
  flex-direction: column;
}
.sidebar h2 {
  font-size: 1.2rem;
  padding: 15px;
  border-bottom: 1px solid #e5e7eb;
  margin: 0;
}
.filter {
  display: flex;
  justify-content: space-around;
  padding: 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.filter button {
  background: #fff;
  border: 1px solid #ddd;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
}
.filter button.active {
  background: #4f46e5;
  color: #fff;
  border-color: #4f46e5;
}
.chat-list {
  list-style: none;
  margin: 0;
  padding: 0;
  overflow-y: auto;
  flex: 1;
}
.chat-list li {
  padding: 12px 15px;
  border-bottom: 1px solid #f1f1f1;
  cursor: pointer;
  display: flex;
  align-items: center;
}
.chat-list li:hover {
  background: #f3f4f6;
}
.chat-list li.active {
  background: #e5e7eb;
}
.chat-list img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-right: 10px;
  object-fit: cover;
}

/* ===== Main Panel ===== */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.header {
  background: #fff;
  padding: 15px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: #f9fafb;
}
.msg {
  margin-bottom: 15px;
  display: flex;
  align-items: flex-end;
}
.msg.incoming {
  justify-content: flex-start;
}
.msg.outgoing {
  justify-content: flex-end;
}
.msg .bubble {
  display: inline-block;
  padding: 10px 15px;
  border-radius: 15px;
  max-width: 70%;
  position: relative;
}
.msg.incoming .bubble {
  background: #f1f1f1;
}
.msg.outgoing .bubble {
  background: #4f46e5;
  color: white;
}
.msg .time {
  font-size: 0.75rem;
  color: #888;
  margin-top: 3px;
}
.msg .avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin: 0 8px;
  object-fit: cover;
}

/* ===== Typing Indicator ===== */
.typing-indicator {
  display: none;
  margin: 10px 0;
  align-items: center;
  font-size: 0.9rem;
  color: #666;
}
.typing-indicator.active {
  display: flex;
}
.typing-indicator img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  margin-right: 8px;
}
.typing-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  margin: 0 2px;
  background: #ccc;
  border-radius: 50%;
  animation: blink 1.4s infinite both;
}
.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}
.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}
@keyframes blink {
  0%, 80%, 100% { opacity: 0; }
  40% { opacity: 1; }
}

/* ===== Input Area ===== */
.input-area {
  display: flex;
  padding: 10px;
  border-top: 1px solid #e5e7eb;
  background: #fff;
}
.input-area input {
  flex: 1;
  padding: 10px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  outline: none;
}
.input-area button {
  margin-left: 10px;
  padding: 10px 20px;
  background: #4f46e5;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.input-area button:hover {
  background: #4338ca;
}
.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
}
.status-online { background: #10b981; }
.status-offline { background: #9ca3af; }
</style>
</head>
<body>
  <div class="sidebar">
    <h2>Chats</h2>
    <div class="filter">
      <button id="filterAll" class="active" onclick="setFilter('all')">All</button>
      <button id="filterWA" onclick="setFilter('whatsapp')">WhatsApp</button>
      <button id="filterFB" onclick="setFilter('facebook')">Facebook</button>
    </div>
    <ul class="chat-list" id="chatList"></ul>
  </div>

  <div class="main">
    <div class="header">
      <div><span class="status-dot status-online"></span><span id="chatTitle">Select a contact</span></div>
      <div><button onclick="connectAccount()">Connect Account</button></div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="typing-indicator" id="typingIndicator">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="AI Assistant" />
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
      <span>AI Assistant is typing...</span>
    </div>

    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type a message..." oninput="simulateTyping()" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

<script>
const API_BASE = 'https://ilawdun.us/wp-json/wa-fb-ai/v1'; // change to your domain
let currentClientId = 1;
let currentRecipient = null;
let filter = 'all';
let typingTimer;

async function loadChats() {
  const res = await fetch(`${API_BASE}/admin/clients`, { credentials: 'include' });
  const clients = await res.json();
  renderChats(clients);
}

function renderChats(clients) {
  const list = document.getElementById('chatList');
  list.innerHTML = '';
  clients
    .filter(c => filter === 'all' || c.channel === filter)
    .forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `
        <img src="${c.channel === 'whatsapp'
          ? 'https://cdn-icons-png.flaticon.com/512/733/733585.png'
          : 'https://cdn-icons-png.flaticon.com/512/733/733547.png'}" alt="icon">
        <div>
          <div><strong>${c.client_name}</strong></div>
          <small>${c.business_type}</small>
        </div>`;
      li.onclick = () => openChat(c);
      list.appendChild(li);
    });
}

function setFilter(type) {
  filter = type;
  document.querySelectorAll('.filter button').forEach(b => b.classList.remove('active'));
  document.getElementById('filter' + (type === 'all' ? 'All' : type === 'whatsapp' ? 'WA' : 'FB')).classList.add('active');
  loadChats();
}

async function openChat(client) {
  document.getElementById('chatTitle').textContent = client.client_name;
  currentClientId = client.id;
  currentRecipient = client.wa_phone_id || client.fb_page_id;
  await loadMessages();
}

async function loadMessages() {
  const res = await fetch(`${API_BASE}/messages?client_id=${currentClientId}`);
  const msgs = await res.json();
  const box = document.getElementById('messages');
  box.innerHTML = '';
  msgs.forEach(m => {
    const div = document.createElement('div');
    const time = new Date(m.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    div.className = 'msg ' + (m.direction === 'out' ? 'outgoing' : 'incoming');
    div.innerHTML = `
      ${m.direction === 'in'
        ? `<img class="avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="AI">`
        : `<img class="avatar" src="https://cdn-icons-png.flaticon.com/512/219/219969.png" alt="You">`}
      <div>
        <div class="bubble">${m.message}</div>
        <div class="time">${time}</div>
      </div>`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

async function sendMessage() {
  const text = document.getElementById('messageInput').value.trim();
  if (!text || !currentClientId) return;

  showTyping(true);

  await fetch(`${API_BASE}/admin/send-test`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
      client_id: currentClientId,
      channel: 'whatsapp',
      to: currentRecipient,
      text
    })
  });

  document.getElementById('messageInput').value = '';
  await loadMessages();

  // Simulate AI reply delay
  setTimeout(async () => {
    showTyping(false);
    await loadMessages();
  }, 2000);
}

function simulateTyping() {
  showTyping(true);
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => showTyping(false), 1500);
}

function showTyping(show) {
  document.getElementById('typingIndicator').classList.toggle('active', show);
}

async function connectAccount() {
  alert('Redirecting to Meta OAuth for WhatsApp / Facebook...');
  try {
    const res = await fetch(`${API_BASE}/oauth/start`);
    const data = await res.json();
    if (data.auth_url) {
      window.location.href = data.auth_url;  // Redirect to Facebook OAuth page
    } else {
      alert('Failed to get authorization URL');
    }
  } catch (err) {
    alert('Error connecting to OAuth: ' + err.message);
  }
}

async function checkLogin() {
  try {
    const res = await fetch(`${API_BASE}/admin/check-login`, { credentials: 'include' });
    if (res.status === 200) {
      await loadChats();
    } else {
      alert('Please connect your account first.');
    }
  } catch {
    alert('Error checking login status');
  }
}

// Call checkLogin on page load
checkLogin();



loadChats();
setInterval(loadMessages, 6000); // refresh messages every 6s
</script>
</body>
</html>
